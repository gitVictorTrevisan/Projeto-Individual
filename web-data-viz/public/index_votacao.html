<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Markazi+Text:wght@400..700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style_votacao.css" />
  <title>Path of Exile - Votação de melhor liga</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterDadosGrafico()">
  <div class="painel">
    <header>
      <img src="imgs/poe-logo.png" alt="logo_game_awards" width="200px" />
    </header>
    <div class="titulos main-font-color">
      <h1>VOTE QUAL A MELHOR LIGA</h1>
    </div>
    <div class="jogos-concorrentes">
      <div class="section">
        <div class="banner" onclick="votar('1')">
          <img src="./imgs/banner de liga/Onslaught_league_banner.png" />
          <p>Onslaught League</p>
        </div>
        <div class="banner" onclick="votar('2')">
          <img src="./imgs/banner de liga/Anarchy_league_banner.png" />
          <p>Anarchy League</p>
        </div>
        <div class="banner" onclick="votar('3')">
          <img src="./imgs/banner de liga/Domination_league_banner.png" />
          <p>Domination League</p>
        </div>
        <div class="banner" onclick="votar('4')">
          <img src="./imgs/banner de liga/Nemesis_league_banner.png" />
          <p>Nemesis League</p>
        </div>
        <div class="banner" onclick="votar('5')">
          <img src="./imgs/banner de liga/Invasion_league_banner.png" />
          <p>Invasion League</p>
        </div>
        <div class="banner" onclick="votar('6')">
          <img src="./imgs/banner de liga/Ambush_league_banner.png" />
          <p>Ambush League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('7')">
          <img src="./imgs/banner de liga/Beyond_league_banner.png" />
          <p>Beyond League</p>
        </div>
        <div class="banner" onclick="votar('8')">
          <img src="./imgs/banner de liga/Rampage_league_banner.png" />
          <p>Rampage League</p>
        </div>
        <div class="banner" onclick="votar('9')">
          <img src="./imgs/banner de liga/Torment_league_banner.png" />
          <p>Torment League</p>
        </div>
        <div class="banner" onclick="votar('10')">
          <img src="./imgs/banner de liga/Bloodlines_league_banner.png" />
          <p>Bloodlines League</p>
        </div>
        <div class="banner" onclick="votar('11')">
          <img src="./imgs/banner de liga/Tempest_league_banner.png" />
          <p>Tempest League</p>
        </div>
        <div class="banner" onclick="votar('12')">
          <img src="./imgs/banner de liga/Warbands_league_banner.png" />
          <p>Warbands League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('13')">
          <img src="./imgs/banner de liga/Talisman_league_banner.png" />
          <p>Talisman League</p>
        </div>
        <div class="banner" onclick="votar('14')">
          <img src="./imgs/banner de liga/Perandus_league_banner.png" />
          <p>Perandus League</p>
        </div>
        <div class="banner" onclick="votar('15')">
          <img src="./imgs/banner de liga/Prophecy_league_banner.png" />
          <p>Prophecy League</p>
        </div>
        <div class="banner" onclick="votar('16')">
          <img src="./imgs/banner de liga/Essence_league_banner.png" />
          <p>Essence League</p>
        </div>
        <div class="banner" onclick="votar('17')">
          <img src="./imgs/banner de liga/Breach_league_banner.png" />
          <p>Breach League</p>
        </div>
        <div class="banner" onclick="votar('18')">
          <img src="./imgs/banner de liga/Legacy_league_banner.png" />
          <p>Legacy League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('19')">
          <img src="./imgs/banner de liga/Harbinger_league_banner.png" />
          <p>Harbinger League</p>
        </div>
        <div class="banner" onclick="votar('20')">
          <img src="./imgs/banner de liga/Abyss_league_banner.png" />
          <p>Abyss League</p>
        </div>
        <div class="banner" onclick="votar('21')">
          <img src="./imgs/banner de liga/Bestiary_league_banner.png" />
          <p>Bestiary League</p>
        </div>
        <div class="banner" onclick="votar('22')">
          <img src="./imgs/banner de liga/Incursion_league_banner.png" />
          <p>Incursion League</p>
        </div>
        <div class="banner" onclick="votar('23')">
          <img src="./imgs/banner de liga/Delve_league_banner.png" />
          <p>Delve League</p>
        </div>
        <div class="banner" onclick="votar('24')">
          <img src="./imgs/banner de liga/Betrayal_league_banner.png" />
          <p>Betrayal League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('25')">
          <img src="./imgs/banner de liga/Synthesis_league_banner.png" />
          <p>Systhesis League</p>
        </div>
        <div class="banner" onclick="votar('26')">
          <img src="./imgs/banner de liga/Legion_league_banner.png" />
          <p>Legion League</p>
        </div>
        <div class="banner" onclick="votar('27')">
          <img src="./imgs/banner de liga/Blight_league_banner.png" />
          <p>Blight League</p>
        </div>
        <div class="banner" onclick="votar('28')">
          <img src="./imgs/banner de liga/Metamorph_league_banner.png" />
          <p>Metamorph League</p>
        </div>
        <div class="banner" onclick="votar('29')">
          <img src="./imgs/banner de liga/Delirium_league_banner.png" />
          <p>Delirium League</p>
        </div>
        <div class="banner" onclick="votar('30')">
          <img src="./imgs/banner de liga/Harvest_league_banner.png" />
          <p>Harvest League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('31')">
          <img src="./imgs/banner de liga/Heist_league_banner.png" />
          <p>Heist League</p>
        </div>
        <div class="banner" onclick="votar('32')">
          <img src="./imgs/banner de liga/Ritual_league_banner.png" />
          <p>Ritual League</p>
        </div>
        <div class="banner" onclick="votar('33')">
          <img src="./imgs/banner de liga/Ultimatum_league_banner.png" />
          <p>Ultimatum League</p>
        </div>
        <div class="banner" onclick="votar('34')">
          <img src="./imgs/banner de liga/Expedition_league_banner.png" />
          <p>Expedition League</p>
        </div>
        <div class="banner" onclick="votar('35')">
          <img src="./imgs/banner de liga/Scourge_league_banner.png" />
          <p>Scourge League</p>
        </div>
        <div class="banner" onclick="votar('36')">
          <img src="./imgs/banner de liga/Archnemesis_league_banner.png" />
          <p>Archnemesis League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('37')">
          <img src="./imgs/banner de liga/Sentinel_league_banner.png" />
          <p>Sentinel League</p>
        </div>
        <div class="banner" onclick="votar('38')">
          <img src="./imgs/banner de liga/Kalandra_league_banner.png" />
          <p>Kalandra League</p>
        </div>
        <div class="banner" onclick="votar('39')">
          <img src="./imgs/banner de liga/Sanctum_league_banner.png" />
          <p>Sanctum League</p>
        </div>
        <div class="banner" onclick="votar('40')">
          <img src="./imgs/banner de liga/Crucible_league_banner.png" />
          <p>Crucible League</p>
        </div>
        <div class="banner" onclick="votar('41')">
          <img src="./imgs/banner de liga/Ancestor_league_banner.png" />
          <p>Ancestor League</p>
        </div>
        <div class="banner" onclick="votar('42')">
          <img src="./imgs/banner de liga/Affliction_league_banner.png" />
          <p>Affliction League</p>
        </div>
      </div>
      <div class="section">
        <div class="banner" onclick="votar('43')">
          <img src="./imgs/banner de liga/Necropolis_league_banner.png" />
          <p>Necropolis League</p>
        </div>
        <div class="banner" onclick="votar('44')">
          <img src="./imgs/banner de liga/Settlers_league_banner.png" />
          <p>Settlers League</p>
        </div>
      </div>
      <div class="grafico">
        <canvas id="myCanvas" width="100vw"></canvas>
      </div>
    </div>
</body>

</html>
<script>
  let myChart;

  function votar(fkLiga) {
    fetch(`/votos/votar/${fkLiga}`, {
      method: "POST",
    })
      .then((response) => {
        if (response.ok) {
          console.log(`Voto contabilizado`);
          atualizarGrafico();
        } else {
          console.error("Erro na votação ou jogo não encontrado");
        }
      })
      .catch(function (error) {
        console.error(`Erro ao realizar o voto: ${error.message}`);
      });
  }

  function obterDadosGrafico() {
    fetch(`/votos/ultimos`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

            plotarGrafico(resposta);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  function plotarGrafico(resposta) {
    console.log("iniciando plotagem do gráfico...");

    // Criando estrutura para plotar gráfico - labels
    let labels = [
      "Onslaught league",
      "Anarchy league",
      "Domination league",
      "Nemesis league",
      "Invasion league",
      "Ambush league",
      "Beyond league",
      "Rampage league",
      "Torment league",
      "Bloodlines league",
      "Tempest league",
      "Warbands league",
      "Talisman league",
      "Perandus league",
      "Prophecy league",
      "Essence league",
      "Breach league",
      "Legacy league",
      "Harbinger league",
      "Abyss league",
      "Bestiary league",
      "Incursion league",
      "Delve league",
      "Betrayal league",
      "Synthesis league",
      "Legion league",
      "Blight league",
      "Metamorph league",
      "Delirium league",
      "Harvest league",
      "Heist league",
      "Ritual league",
      "Ultimatum league",
      "Expedition league",
      "Scourge league",
      "Archnemesis league",
      "Sentinel league",
      "Kalandra league",
      "Sanctum league",
      "Crucible league",
      "Ancestor league",
      "Affliction league",
      "Necropolis league",
      "Settlers league"
    ];


    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [
        {
          label: "Votos",
          data: ['0', '0'],
          fill: false,
          backgroundColor: [
            "rgba(75, 192, 192, 0.2)",
            "rgba(255, 99, 132, 0.2)",
            "rgba(54, 162, 235, 0.2)",
          ],
          borderColor: [
            "rgba(75, 192, 192, 1)",
            "rgba(255, 99, 132, 1)",
            "rgba(54, 162, 235, 1)",
          ],
          borderWidth: 1,
          tension: 0.1,
        },
      ],
    };

    console.log("----------------------------------------------");
    console.log(
      'Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":'
    );
    console.log(resposta);

    // Inserindo valores recebidos em estrutura para plotar o gráfico

    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      dados.datasets[0].data.push(registro.votos);
    }

    console.log("----------------------------------------------");
    console.log("O gráfico será plotado com os respectivos valores:");
    console.log("Labels:");
    console.log(labels);
    console.log("Dados:");
    console.log(dados.datasets.data);
    console.log("----------------------------------------------");

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: "bar",
      data: dados,
      options: {
        responsive: true,
        scales: {
          x: {
            ticks: {
              autoSkip: false
            }
          },
          y: {
            beginAtZero: true,
          },
        },
        plugins: {
          title: {
            display: true,
            text: "VOTAÇÃO",
            color: "#FFFFFF",
            font: {
              size: 20,
            },
          },
          legend: {
            display: true,
            labels: {
              color: "white",
            },
          },
        },
      },
    };

    // Adicionando gráfico criado em div na tela
    myChart = new Chart(document.getElementById("myCanvas"), config);
  }

  function atualizarGrafico() {
    fetch(`/votos/ultimos`, { cache: "no-store" })
      .then(function (resposta) {
        if (resposta.ok) {
          resposta.json().then(function (respostaJSON) {
            console.log(`Dados recebidos: ${JSON.stringify(respostaJSON)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(myChart.data);

            myChart.data.datasets[0].data = [];

            for (let i = 0; i < respostaJSON.length; i++) {
              myChart.data.datasets[0].data.push(respostaJSON[i].votos);
            }

            myChart.update();
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }
</script>